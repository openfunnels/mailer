jQuery(document).ready(function(e){var p=e(".import-status"),a=e(".export-status"),f=e("#progress"),g=f.find(".bar"),h=e("#mailster_nonce").val(),n=null,l=0,q,o,m=function(){var t=new plupload.Uploader(wpUploaderInit);t.bind("Init",function(u){var v=e("#plupload-upload-ui");if(u.features.dragdrop&&!e(document.body).hasClass("mobile")){v.addClass("drag-drop");e("#drag-drop-area").bind("dragover.wp-uploader",function(){v.addClass("drag-over")}).bind("dragleave.wp-uploader, drop.wp-uploader",function(){v.removeClass("drag-over")})}else{v.removeClass("drag-drop");e("#drag-drop-area").unbind(".wp-uploader")}if(u.runtime=="html4"){e(".upload-flash-bypass").hide()}});t.bind("FilesAdded",function(u,v){e("#media-upload-error").html("");e("#wordpress-users").fadeOut();setTimeout(function(){u.refresh();u.start()},1)});t.bind("BeforeUpload",function(u,v){f.removeClass("finished error hidden");p.html("uploading")});t.bind("UploadFile",function(u,v){});t.bind("UploadProgress",function(u,v){p.html(i(mailsterL10n.uploading,v.percent+"%"));g.stop().animate({width:v.percent+"%"},100)});t.bind("Error",function(u,v){p.html(v.message);f.addClass("error");u.refresh()});t.bind("FileUploaded",function(u,w,v){v=e.parseJSON(v.response);o=v.identifier;if(!v.success){p.html(v.message);f.addClass("error");u.refresh();t.unbind("UploadComplete")}});t.bind("UploadComplete",function(u,v){p.html(mailsterL10n.prepare_data);f.addClass("finished");d()});t.init()};if(typeof(wpUploaderInit)=="object"){m()}e(".wrap").on("change","#signup",function(){e("#signupdate").prop("disabled",!e(this).is(":checked"))}).on("click",".do-import",function(){var D=e("#lists").serialize(),v=e("#subscriber-table").serialize();if(!/%5D=email/.test(v)){alert(mailsterL10n.select_emailcolumn);return false}if(!e('input[name="status"]:checked').length){alert(mailsterL10n.select_status);return false}if(!confirm(mailsterL10n.confirm_import)){return false}var x=e(this).prop("disabled",true),w=e('input[name="status"]:checked').val(),t=e('input[name="existing"]:checked').val(),z=e("#signup").is(":checked"),u=e("#signupdate").val(),C=e("#keepstatus").is(":checked"),B=e("#import-ajax-loading").css({display:"inline-block"}),y=e("#identifier").val(),A=e("#performance").is(":checked");f.removeClass("hidden");g.stop().width(0);e(".step1").slideUp();e(".step2-body").html("<br><br>").parent().show();q=new Date();r(0,{identifier:y,order:v,lists:D,status:w,keepstatus:C,existing:t,signupdate:z?u:null,performance:A});p.html(mailsterL10n.prepare_import);window.onbeforeunload=function(){return mailsterL10n.onbeforeunloadimport}}).on("change",".wordpress-users-toggle",function(){e(this).parent().parent().parent().find("li input").prop("checked",e(this).prop("checked"))}).on("click","#addlist",function(){var t=e("#new_list_name").val();if(!t){return false}e('<li><label><input name="lists[]" value="'+t+'" type="checkbox" checked> '+t+" </label></li>").appendTo("#lists > ul");e("#new_list_name").val("")}).on("change",".list-toggle",function(){e(this).parent().parent().parent().find("ul input").prop("checked",e(this).prop("checked"))}).on("change",'input[name="status"]',function(){if(e(this).val()<=0){e(".pending-info").show()}else{e(".pending-info").hide()}});e("#paste-import").on("focus",function(){e(this).val("").addClass("focus")}).on("blur",function(){e(this).removeClass("focus");var t=e.trim(e(this).val());if(t){b("import_subscribers_upload_handler",{data:t},function(u){if(u.success){o=u.identifier;e("#wordpress-users").fadeOut();d()}else{p.html(u.message);f.addClass("error")}},function(){p.html("Error")})}});e("#import_wordpress").on("submit",function(){var t=e(this).serialize();b("import_subscribers_upload_handler",{wordpressusers:t},function(u){if(u.success){o=u.identifier;e("#wordpress-users").fadeOut();d()}else{p.html(u.message);f.addClass("error")}},function(){p.html("Error")});return false});e('select[name="outputformat"]').on("change",function(){e("#csv-separator")[e(this).val()=="csv"?"show":"hide"]()});e(".export-order").sortable({connectWith:".export-order",_placeholder:"ui-state-highlight",containment:".export-order-wrap",receive:function(t,u){u.item.find("input").prop("checked",u.item.closest(".export-order").is(".selected"))}}).on("change","input",function(){var t=e(this);t.parent().appendTo(t.is(":checked")?e(".export-order.selected"):e(".export-order.unselected"))});e(".export-order-wrap").on("click",".export-order-add",function(){e(".export-order.unselected").find("li").appendTo(".export-order.selected").find("input").prop("checked",true);return false}).on("click",".export-order-remove",function(){e(".export-order.selected").find("li").appendTo(".export-order.unselected").find("input").prop("checked",false);return false});e("#export-subscribers").on("submit",function(){var t=e(this).serialize();b("export_contacts",{data:t},function(v){if(v.success){window.onbeforeunload=function(){return mailsterL10n.onbeforeunloadexport};var u=e(".performance").val();e(".step2").slideDown();e(".step2-body").html(i(mailsterL10n.write_file,"0.00 Kb"));f.removeClass("finished error hidden");g.stop().width(0);c(0,u,v.count,t)}else{alert(v.msg)}},function(u,w,v){alert(w)});return false});e("#delete-subscribers").on("submit",function(){var t=prompt(mailsterL10n.confirm_delete,"");if(!t){return false}if("delete"==t.toLowerCase()){var u=e(this).serialize();f.removeClass("finished error hidden");g.stop().animate({width:"99%"},25000);b("delete_contacts",{data:u},function(v){if(v.success){g.stop().animate({width:"100%"},200,function(){e(".delete-status").html(v.msg);f.addClass("finished")})}else{g.stop();e(".delete-status").html(v.msg);f.addClass("error")}},function(v,x,w){g.stop();e(".delete-status").html("["+v.status+"] "+w);f.addClass("error")})}return false});e("#delete-subscribers").on("change","input, select",j);j();function j(){setTimeout(function(){var t=e("#delete-subscribers").serialize();e("#delete-subscriber-button").prop("disabled",true);b("get_subscriber_count",{data:t},function(u){if(u.success){e("#delete-subscriber-button").val(i(mailsterL10n.delete_n_subscribers,u.count)).prop("disabled",!u.count)}})},10)}e("input.selectall").on("change",function(){var u=e(this),t=u.attr("name");e('input[name="'+t+'"]').prop("checked",u.prop("checked"))});function c(z,v,x,y){var w=new Date().getTime(),u=(Math.min(1,(v*z)/x)*100);a.html(i(mailsterL10n.prepare_download,x,""));b("do_export",{limit:v,offset:z,data:y},function(t){var A=u>=100&&t.finished;if(t.success){if(!A){c(z+1,v,x,y)}g.animate({width:(u)+"%"},{duration:1000,easing:"swing",queue:false,step:function(B){a.html(i(mailsterL10n.prepare_download,x,Math.ceil(B)+"%"))},complete:function(){a.html(i(mailsterL10n.prepare_download,x,Math.ceil(u)+"%"));if(A){window.onbeforeunload=null;f.addClass("finished");e(".step2-body").html(mailsterL10n.export_finished);a.html(i(mailsterL10n.downloading,x));if(t.filename){setTimeout(function(){document.location=t.filename},1000)}}else{e(".step2-body").html(i(mailsterL10n.write_file,t.total))}}})}else{g.stop();f.addClass("error");window.onbeforeunload=null;a.html(mailsterL10n.error_export);e(".step2-body").html(t.msg)}},function(t,B,A){})}function r(x,v){var w=new Date().getTime(),u=0;if(!x){x=0}b("do_import",{id:x,options:v},function(t){u=(Math.min(1,(t.imported+t.errors)/t.total)*100);e(".step2-body").html("<p>"+k(t.f_imported,t.f_errors,t.f_total,u,t.memoryusage)+"</p>");l=0;var y=u>=100;if(t.success){if(!y){r(x+1,v)}g.animate({width:(u)+"%"},{duration:1000,easing:"swing",queue:false,step:function(z){p.html(i(mailsterL10n.import_contacts,Math.ceil(z)+"%"))},complete:function(){p.html(i(mailsterL10n.import_contacts,Math.ceil(u)+"%"));if(y){window.onbeforeunload=null;f.addClass("finished");e(".step2-body").html(t.html).slideDown()}}})}else{s(u,x,v)}},function(t,z,y){s(u,x,v)})}function d(){f.removeClass("finished error");b("get_import_data",{identifier:o},function(t){f.addClass("hidden");e(".step1").slideUp();e(".step2-body").html(t.html).parent().show();e("input.datepicker").datepicker({dateFormat:"yy-mm-dd",showAnim:"fadeIn",onClose:function(){}});p.html("");n=t.data})}function s(t,y,v){l++;if(l>=5){alert(mailsterL10n.error_importing);window.onbeforeunload=null;return}var w=l*5,x="",u=setInterval(function(){if(w<=0){clearInterval(u);f.removeClass("paused");r(y,v);x=Math.round(t)+"%"}else{f.addClass("paused");x='<span class="error">'+i(mailsterL10n.continues_in,(w--))+"</span>"}p.html(i(mailsterL10n.import_contacts,x))},1000)}function k(x,z,w,u,t){var y=new Date().getTime()-q.getTime(),v=Math.ceil(((100-u)*(y/u))/60000);return i(mailsterL10n.current_stats,"<strong>"+x+"</strong>","<strong>"+w+"</strong>","<strong>"+z+"</strong>","<strong>"+t+"</strong>")+"<br>"+i(mailsterL10n.estimate_time,v)}function b(v,u,w,t){if(e.isFunction(u)){if(e.isFunction(w)){t=w}w=u;u={}}e.ajax({type:"POST",url:ajaxurl,data:e.extend({action:"mailster_"+v,_wpnonce:h},u),success:function(y,z,x){w&&w.call(this,y,z,x)},error:function(x,z,y){if(z=="error"&&!y){return}if(console){console.error(e.trim(x.responseText))}t&&t.call(this,x,z,y)},dataType:"JSON"})}function i(){var t=Array.prototype.slice.call(arguments),x=t.shift(),w=t.length,v;for(var u=0;u<w;u++){v=new RegExp("%("+(u+1)+"\\$)?(s|d|f)");x=x.replace(v,t[u])}return x}});