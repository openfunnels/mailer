jQuery(document).ready(function(h){var r=h("html"),q=h("body"),v,t,x,p,w,l,y,f,c=typeof tinymce!="undefined";if(parent.window==window){var n;if(n=location.search.match(/id=(\d+)/i)[1]){window.location=location.protocol+"//"+location.host+location.pathname.replace("admin-ajax.php","post.php")+"?post="+n+"&action=edit"}}window.ajaxurl=window.ajaxurl||window.mailsterdata.ajaxurl;h(window).on("load",function(){q.on("click","a",function(z){z.preventDefault()}).on("click",function(z){if(f){f.removeAttr("selected")}}).on("click","module",function(z){if("MODULE"==z.target.nodeName){z.stopPropagation();a("selectModule",h(this))}}).on("click","button.addbutton",function(){var A=h(this).data(),z=decodeURIComponent(A.element.data("tmpl"))||'<a href="" editable label="Button"></a>';parent.window.Mailster.editbar.open({type:"btn",offset:A.offset,element:h(z).attr("tmpbutton","").appendTo(A.element),name:A.name});return false}).on("click","button.addrepeater",function(){var C=h(this).data();if("TH"==C.element[0].nodeName||"TD"==C.element[0].nodeName){var B=C.element.closest("table"),z=C.element.prevAll().length;for(var A=B[0].rows.length-1;A>=0;A--){h(B[0].rows[A].cells[z]).clone().insertAfter(B[0].rows[A].cells[z])}}else{C.element.clone().insertAfter(C.element)}a("save");a("refresh");return false}).on("click","button.removerepeater",function(){var C=h(this).data();if("TH"==C.element[0].nodeName||"TD"==C.element[0].nodeName){var B=C.element.closest("table"),z=C.element.prevAll().length;for(var A=B[0].rows.length-1;A>=0;A--){h(B[0].rows[A].cells[z]).remove()}}else{C.element.remove()}a("save");a("refresh");return false});q.find("div.modulebuttons").remove();(mailsterdata.isrtl)?r.attr("mailster-is-rtl",""):r.removeAttr("mailster-is-rtl")});function u(){t=h("modules");x=t.find("module");p=h("img[editable]");w=h("buttons");l=h("[repeatable]");k();b();i();if(c){m()}r.removeClass("mailster-loading")}function j(){g()}function m(){var B=mailster_mce_button.l10n,A=mailster_mce_button.tags,D=mailster_mce_button.designs,z=mailsterdata.tinymce,E,G=false;tinymce.init(h.extend(z.args,z.multi,{urlconverter_callback:F,setup:C}));tinymce.init(h.extend(z.args,z.single,{urlconverter_callback:F,setup:C}));function F(J,K,H,I){if("_wp_link_placeholder"==J){return J}else{if(/^https?:\/\/{.+}/g.test(J)){return J.replace(/^https?:\/\//,"")}else{if(/^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(J)){return"mailto:"+J}}}return this.documentBaseURI.toAbsolute(J,z.remove_script_host)}function C(H){H.addButton("mailster_mce_button",{title:B.tags.title,type:"menubutton",icon:"icon mailster-tags-icon",menu:h.map(A,function(I,J){return{text:I.name,menu:h.map(I.tags,function(L,K){return{text:L,onclick:function(){var M="";switch(K){case"webversion":case"unsub":case"forward":case"profile":M="link";case"homepage":if(y=H.selection.getContent({format:"text"})){H.insertContent('<a href="{'+K+M+'}">'+y+"</a>");break}default:H.insertContent("{"+K+"} ")}}}})}})});H.addButton("mailster_remove_element",{title:B.remove.title,icon:"icon mailster-remove-icon",onclick:function(){H.targetElm.remove();H.remove();a("save")}});H.on("change",function(J){var I=this;clearTimeout(E);E=setTimeout(function(){var L=J.level.content,M=L.match(/rgb\((\d+), ?(\d+), ?(\d+)\)/g);if(M){for(var K=M.length-1;K>=0;K--){L=L.replace(M[K],s(M[K]))}I.bodyElement.innerHTML=L}a("save");G=true},100)}).on("keyup",function(I){h(I.currentTarget).prop("spellcheck",true)}).on("click",function(I){a("selectModule",h(I.currentTarget).closest("module"));I.stopPropagation();H.focus()}).on("focus",function(I){I.stopPropagation();H.selection.select(H.getBody(),true);if(t.data("uiSortable")){t.sortable("destroy")}}).on("blur",function(I){a("refresh");k()})}}function s(B){var z=B.match(/rgb\((\d+), ?(\d+), ?(\d+)\)/);function A(C){C=parseInt(C,10).toString(16);return C.length>1?C:"0"+C}return z?"#"+A(z[1])+A(z[2])+A(z[3]):B}function k(){if(t.data("sortable")){t.sortable("destroy")}if(x.length<2){return}t.sortable({stop:function(z,A){z.stopPropagation();t.removeClass("dragging");setTimeout(function(){a("refresh");a("save")},200)},start:function(z,A){z.stopPropagation();t.addClass("dragging")},containment:"body",revert:100,axis:"y",placeholder:"sortable-placeholder",items:"> module",delay:20,distance:5,scroll:true,scrollSensitivity:10,forcePlaceholderSize:true,helper:"clone",zIndex:10000})}function b(){if(p.data("draggable")){p.draggable("destroy")}if(p.data("droppable")){p.droppable("destroy")}p.draggable({helper:"clone",scroll:true,scrollSensitivity:10,opacity:0.7,zIndex:1000,revert:"invalid",addClasses:false,create:function(z,A){h(z.target).removeClass("ui-draggable-handle")},start:function(){q.addClass("ui-dragging")},stop:function(){q.removeClass("ui-dragging");a("refresh")}}).droppable({addClasses:false,over:function(z,A){h(z.target).addClass("ui-drag-over")},out:function(z,A){h(z.target).removeClass("ui-drag-over")},drop:function(C,D){var G=h(D.draggable[0]),E=h(C.target),z,B,A,F;E.removeClass("ui-drag-over");if(!G.is("img")||!E.is("img")){return}z=E.attr("data-id")?parseInt(E.attr("data-id"),10):null;B=G.attr("data-id")?parseInt(G.attr("data-id"),10):null;A=G.data("crop");F=G.clone();G.addClass("mailster-loading");E.addClass("mailster-loading");d(G,function(H,I,J){d(E,function(L,M,K){if(C.altKey){G.removeClass("mailster-loading");E.removeClass("mailster-loading")}else{if(z){e("create_image",{id:z,width:H,_height:I},function(N){G.removeAttr("src").attr({"data-id":z,title:E.attr("title"),alt:E.attr("alt"),src:N.image.url,width:Math.round(N.image.width/J),height:Math.round(N.image.height/J)}).data("id",z).removeClass("mailster-loading")},function(N,P,O){alert(P+" "+N.status+": "+O+"\n\nCheck the JS console for more info!")})}else{G.removeAttr("src").attr({"data-id":0,title:E.attr("title"),alt:E.attr("alt"),src:E.attr("src"),width:Math.round(H/J),height:Math.round((H/(L/M))/J)}).data("id",0).removeClass("mailster-loading")}}if(B){e("create_image",{id:B,width:L,_height:M},function(N){E.removeAttr("src").attr({"data-id":B,title:G.attr("title"),alt:G.attr("alt"),src:N.image.url,width:Math.round(N.image.width/K),height:Math.round(N.image.height/K)}).data("id",B).removeClass("mailster-loading");a("refresh")},function(N,P,O){alert(P+" "+N.status+": "+O+"\n\nCheck the JS console for more info!")})}else{E.removeAttr("src").attr({"data-id":0,title:F.attr("title"),alt:F.attr("alt"),src:F.attr("src"),width:Math.round(L/K),height:Math.round((L/(H/I))/K)}).data("id",0).removeClass("mailster-loading")}if(!B&&!z){a("refresh")}})})}})}function g(){if(w){h.each(w,function(){var E=h(this),A=E.attr("label"),F=this.getBoundingClientRect(),D=F.top+0,C=F.right+0,B,z;if(E.data("has-buttons")){return}B=h('<button class="addbutton mailster-btn mailster-btn-inline" title="'+mailsterL10n.add_button+'"></button>').appendTo(E);B.data("offset",F).data("name",A);B.data("element",E);E.data("has-buttons",true);if(!(z=E.data("tmpl"))){if(E.find(".textbutton").length){z=E.find(".textbutton").last()}else{if(E.find("img").length){z=E.find("a[editable]").last()}else{z=h('<a href="" editable label="Button"></a>')}}z=h("<div/>").text(encodeURIComponent(z[0].outerHTML)).html()}E.attr("data-tmpl",z).data("tmpl",z)})}h("button.addrepeater, button.removerepeater").remove();if(l){h.each(l,function(){var F=h(this),B=F.closest("module"),z=F.attr("label"),H=B[0].getBoundingClientRect(),C=this.getBoundingClientRect(),E=C.top-H.top,D=C.left,G=C.top-H.top+18,I=C.left,A;if("TH"==this.nodeName||"TD"==this.nodeName){E=0;D=C.width-36;G=0;I=C.width-18}A=h('<button class="addrepeater mailster-btn mailster-btn-inline" title="'+mailsterL10n.add_repeater+'"></button>').css({top:E,left:D}).appendTo(F);A.data("offset",C).data("name",z);A.data("element",F);A=h('<button class="removerepeater mailster-btn mailster-btn-inline" title="'+mailsterL10n.remove_repeater+'"></button>').css({top:G,left:I}).appendTo(F);A.data("offset",C).data("name",z);A.data("element",F)})}}function i(){if(typeof mOxie!="undefined"){h.each(p,function(){var A=h(this),z;if(A.data("has-dropzone")){return}z=new mOxie.FileDrop({drop_zone:this});z.ondrop=function(H){if(parent.window.mailster_is_modulde_dragging){return}A.removeClass("ui-drag-over-file ui-drag-over-file-alt");var E=z.files.shift(),C=window.event&&event.altKey,F=[A.width(),A.height()],B=A.offset(),G=h('<div class="mailster-upload-info"><div class="mailster-upload-info-bar"></div><div class="mailster-upload-info-text"></div></div>').css({width:F[0],height:F[1],top:B.top,left:B.left}),D=new mOxie.Image(E);D.onerror=function(I){alert(mailsterL10n.unsupported_format)};D.onload=function(I){G.appendTo("body");E._element=A;E._altKey=C;E._preview=G;E._dimensions=[D.width,D.height,D.width/D.height];D.downsize(F[0],F[1]);G.find(".mailster-upload-info-bar").css({"background-image":"url("+D.getAsDataURL()+")","background-size":F[0]+"px "+(F[0]/E._dimensions[2])+"px"});v.addFile(E)};D.load(E)};z.ondragenter=function(B){if(parent.window.mailster_is_modulde_dragging){return}A.addClass("ui-drag-over-file");if(window.event&&event.altKey){A.addClass("ui-drag-over-file-alt")}};z.ondragleave=function(B){if(parent.window.mailster_is_modulde_dragging){return}A.removeClass("ui-drag-over-file ui-drag-over-file-alt")};z.onerror=function(B){if(parent.window.mailster_is_modulde_dragging){return}A.removeClass("ui-drag-over-file ui-drag-over-file-alt")};z.init();A.data("has-dropzone",true)});if(!v){h('<button id="mailster-editorimage-upload-button" />').hide().appendTo("body");v=new plupload.Uploader(mailsterdata.plupload);v.bind("Init",function(z){h(".moxie-shim").remove()});v.bind("FilesAdded",function(z,A){var B=A[0].getSource();d(B._element,function(E,C,D){z.settings.multipart_params.width=E;z.settings.multipart_params.height=C;z.settings.multipart_params.factor=D;z.settings.multipart_params.altKey=B._altKey;z.refresh();z.start()})});v.bind("BeforeUpload",function(z,A){});v.bind("UploadFile",function(z,A){});v.bind("UploadProgress",function(z,A){var B=A.getSource();B._preview.find(".mailster-upload-info-bar").width(A.percent+"%");B._preview.find(".mailster-upload-info-text").html(A.percent+"%")});v.bind("Error",function(z,A){var B=A.file.getSource();alert(A.message);B._preview.remove()});v.bind("FileUploaded",function(A,D,B){var F=D.getSource(),C,z;try{B=h.parseJSON(B.response);F._preview.find(".mailster-upload-info-text").html(mailsterL10n.ready);F._element.on("load",function(){clearTimeout(C);F._preview.fadeOut(function(){h(this).remove();a("refresh")})});z=Math.round(F._element.width()/B.image.asp);F._element.attr({src:B.image.url,height:z,"data-id":B.image.id||0}).data("id",B.image.id||0);F._preview.height(z);C=setTimeout(function(){F._preview.fadeOut(function(){h(this).remove();a("refresh")})},3000)}catch(E){F._preview.addClass("error").find(".mailster-upload-info-text").html(mailsterL10n.error);alert(mailsterL10n.error_occurs+"\n"+E.message);F._preview.fadeOut(function(){h(this).remove()})}});v.bind("UploadComplete",function(z,A){});v.init()}}}h(window).on("Mailster:refresh",function(){u()}).on("Mailster:resize",function(){j()}).on("Mailster:selectModule",function(A){if(!A.detail){return}var z=h(A.detail[0]);if(f){f.removeAttr("selected")}f=z;f.attr("selected",true)});function a(){if(!window.Mailster){window.Mailster=parent.window.Mailster}if(!window.Mailster){return}var A=jQuery.makeArray(arguments);var z=A.shift();window.Mailster.trigger(z,A)}function d(A,C){A=A.eq(0);if(A.is("img")&&A.attr("src")&&C){var B=new Image(),z;B.onload=function(){z=Math.max(1,Math.min(2,((B.width/(A.attr("width")||A.width())).toFixed(1)||1)));C.call(this,B.width,B.height,isFinite(z)?parseFloat(z):1)};B.src=A.attr("src")}}function e(C,B,D,A,z){if(h.isFunction(B)){if(h.isFunction(D)){A=D}D=B;B={}}h.ajax({type:"POST",url:window.mailsterdata.ajaxurl,data:h.extend({action:"mailster_"+C,_wpnonce:window.mailsterdata._wpnonce},B),success:function(F,G,E){D&&D.call(this,F,G,E)},error:function(E,G,F){if(G=="error"&&!F){return}if(console){console.error(h.trim(E.responseText))}A&&A.call(this,E,G,F)},dataType:z?z:"JSON"})}function o(){var z=Array.prototype.slice.call(arguments),D=z.shift(),C=z.length,B;for(var A=0;A<C;A++){B=new RegExp("%("+(A+1)+"\\$)?(s|d|f)");D=D.replace(B,z[A])}return D}});document.getElementsByTagName("html")[0].className+=" mailster-loading";